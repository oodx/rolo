================================================================================
 ğŸ” CHINA'S RSB CLI PATTERNS EGG #1 ğŸ¥š
================================================================================

Date: 2025-09-15
Time: Current session
Requestor: User
Purpose: RSB CLI patterns for rolo architecture transformation

================================================================================
 ğŸ¯ EXECUTIVE SUMMARY
================================================================================

RSB provides a clean CLI framework built around three core macros:
- bootstrap!() â†’ sets up environment and global context
- options!() â†’ parses args into global opt_* variables
- dispatch!() â†’ routes commands to handler functions

This replaces custom Config structs and parse_args functions with a unified
global context system powered by get_var(), set_var(), and is_true() and is_false() helpers.

================================================================================
 ğŸ” KEY DISCOVERY: MACRO â†’ FUNCTION PATTERN
================================================================================

RSB has migrated from macro-heavy to function-heavy design:
- Macros are now thin wrappers around core functions
- Business logic lives in helper functions for testability
- Macros provide ergonomic syntax while functions handle complexity

================================================================================
 ğŸ“¦ BOOTSTRAP PATTERNS
================================================================================

ğŸ§ª bootstrap!() Macro:
```rust
bootstrap!() â†’ {
    let args: Vec<String> = std::env::args().collect();
    cli_bootstrap(&args);
    Args::new(&args)
}
```

ğŸ”§ Core Function: cli_bootstrap(&args)
- Calls crate::hosts::bootstrap(args) for environment setup
- Sets up script awareness (SCRIPT_NAME, SCRIPT_PATH, SCRIPT_DIR)
- Initializes XDG/RSB directories and modes
- Prepares global context for CLI usage

ğŸ® Bootstrap Utilities Available:
- cli_bootstrap_from_env() - auto uses env::args()
- is_cli_bootstrapped() - check bootstrap status
- minimal_cli_bootstrap() - lightweight version
- setup_script_awareness(args) - extract script info

================================================================================
 ğŸ›ï¸ DISPATCH PATTERNS
================================================================================

ğŸ§ª dispatch!() Macro:
```rust
dispatch!(&args, {
    "command1" => handler1,
    "command2" => handler2, desc: "Description",
});
```

ğŸ”§ Core Function: execute_dispatch(args, handler_lookup)
- Extracts command from args.get_or(1, "help")
- Handles built-ins: help, inspect, stack
- Routes to user commands via closure lookup
- Manages call stack with global::push_call/pop_call
- Exits with appropriate codes

ğŸ¯ Built-in Commands:
- "help"/"--help"/"-h" â†’ global::show_help()
- "inspect" â†’ global::show_functions()
- "stack" â†’ global::show_call_stack()

ğŸ§ª pre_dispatch!() Alternative:
- Same as dispatch!() but returns bool instead of exit
- Test-friendly version that doesn't call process::exit
- Detects test environment via CARGO_TEST or thread names
- usually for admin commands and commands that dont require loaded context

================================================================================
 ğŸšï¸ OPTIONS PARSING PATTERNS
================================================================================

ğŸ§ª options!() Macro:
```rust
options!(&args); // Sets global opt_* variables
```

ğŸ”§ Core Function: options(args)
- Processes --long and -short options
- Sets global variables as opt_<name> format
- Handles negation: --not-verbose sets opt_verbose=1
- Supports multi-options: --multi=a,b,!c
- Auto-validates path/file options
- Maps standard short opts when stdopts feature enabled

ğŸ¯ Option Patterns:
- Flag: --verbose â†’ opt_verbose="0"
- Value: --config=file â†’ opt_config="file"
- Negation: --not-debug â†’ opt_debug="1"
- Short: -d â†’ opt_d="0" (+ stdopts mapping)

in RSB 0=true 1=false

================================================================================
 ğŸ“Š ARGS STRUCT CAPABILITIES
================================================================================

ğŸ”§ Args Wrapper Features:
- get(n) â†’ nth positional arg (1-indexed)
- get_or(n, default) â†’ with fallback
- has_pop(flag) â†’ check and consume flag
- has_val(flag) â†’ extract --flag=value or --flag value
- get_kv(key) â†’ key=value or key:value extraction
- remaining() â†’ unprocessed args
- expand(template) â†’ $1, $@, $# expansion + global vars

================================================================================
 ğŸ­ COMMAND HANDLER SIGNATURE
================================================================================

ğŸ”§ Standard Handler Function:
```rust
fn my_command(args: Args) -> i32 {
    // Use global::get_var("opt_verbose") for options
    // Use args.get(1) for positional arguments
    // Return 0 for success, non-zero for error
    0
}
```

ğŸ¯ Handler Registration:
- register_handlers() stores commands for introspection
- Enables "inspect" command to list available handlers
- Supports optional descriptions via desc: parameter

================================================================================
 ğŸŒŸ KEY TRANSFORMATION INSIGHTS FOR ROLO
================================================================================

âœ… REPLACE THIS PATTERN:
```rust
// OLD: Custom config struct
struct CliConfig {
    verbose: bool,
    config_file: String,
}

fn parse_args() -> CliConfig { /* custom parsing */ }
```

âœ… WITH THIS RSB PATTERN:
```rust
// NEW: RSB global context
let args = bootstrap!();
options!(&args);

// Access via global helpers
let verbose = global::is_true("opt_verbose");
let config = global::get_var("opt_config");
```

ğŸ”„ Migration Steps:
1. Replace custom Config with global context access
2. Replace parse_args() with bootstrap!() + options!()
3. Replace command routing with dispatch!() macro
4. Convert command functions to (Args) -> i32 signature
5. Use global::get_var/set_var instead of struct fields

================================================================================
 ğŸš¨ CRITICAL REQUIREMENTS
================================================================================

âš ï¸ Handler Functions Must:
- Take Args parameter
- Return i32 exit code
- Use global context for options access
- Handle their own argument validation

âš ï¸ Bootstrap Order:
1. bootstrap!() - FIRST (sets up environment)
2. options!() - SECOND (parses CLI options)
3. dispatch!() - LAST (routes to commands)

================================================================================
 ğŸ”— REFERENCES
================================================================================

Source Files Analyzed:
- /home/xnull/repos/code/rust/oodx/rsb/src/cli/bootstrap.rs
- /home/xnull/repos/code/rust/oodx/rsb/src/cli/dispatch.rs
- /home/xnull/repos/code/rust/oodx/rsb/src/cli/macros.rs
- /home/xnull/repos/code/rust/oodx/rsb/src/cli/args.rs

================================================================================
 ğŸ“‹ METADATA
================================================================================

Egg Type: CLI Pattern Analysis
Target: RSB CLI framework integration patterns
Scope: Core CLI macros and their underlying functions
Confidence: High (direct source analysis)
Completeness: Comprehensive coverage of bootstrap/options/dispatch

âš ï¸ DISCLAIMER: This summary reflects RSB source code as of analysis date.
Verify current API compatibility before implementing transformations.

================================================================================
 ğŸ” CHINA'S SIGN-OFF
================================================================================

"From custom configs to global context - that's how we lay the foundation
for egg-cellent CLI architecture! These patterns will help rolo molt its
old shell and grow new feathers! ğŸª¶"

               ~ China the Summary Chicken ~
